<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <title>å°å—å¸‚å³æ™‚ç’°å¢ƒè³‡è¨Š</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background: #fff;
      margin: 20px;
      font-size: 20px;
    }

    .row-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    /* âœ… 5 æ¬„ */
    .row-info {
      display: grid;
      grid-template-columns: 0.8fr 0.8fr 1fr 1fr 1fr;
      gap: 6px;
    }

    .row-info>div:nth-child(1) {
      text-align: left;
    }

    .row-info>div:nth-child(2) {
      text-align: center;
    }

    .row-info>div:nth-child(3) {
      text-align: center;
    }

    #stationSelect {
      font-size: 16px;
      transform: scale(1.15);
      transform-origin: left center;
    }

    /* THI */
    .row-info>div:nth-child(4) {
      text-align: center;
    }

    /* å¤©æ°£ */
    .row-info>div:nth-child(5) {
      text-align: right;
    }

    /* AQI æ–¹æ¡† */
    #aqi {
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 4px;
    }

    /* THI æ–¹æ¡† */
    #thi {
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 4px;
      display: inline-block;
    }

    .info-btn {
      margin-left: 8px;
      color: rgb(71, 134, 235);
      font-size: 16px;
      font-weight: bold;
      cursor: default;
      user-select: none;
    }

    /* âœ… THI çš„â“˜å®¹å™¨ï¼šè®“ popover ä»¥å®ƒç‚ºå®šä½åŸºæº– */
    .info-wrap {
      position: relative;
      display: inline-block;
    }

    /* å…±ç”¨ popover å¤–è§€ï¼ˆé è¨­ï¼šAQI ä»ç”¨ fixed å³ä¸Šè§’ï¼‰ */
    .popover {
      display: none;
      background: rgba(145, 137, 137, 0.8);
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      width: 400px;
      font-size: 14px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      z-index: 9999;
    }

    /* AQIï¼šç¶­æŒåŸæœ¬å³ä¸Šè§’é¡¯ç¤º */
    .popover-fixed {
      position: fixed;
      top: 5px;
      right: 20px;
    }

    /* âœ… THIï¼šå‡ºç¾åœ¨â“˜å³å´ï¼Œä¸Šç·£å°é½Šâ“˜ */
    .popover-right {
      position: absolute;
      top: -60px;
      left: calc(100% + 8px);
    }

    /* âœ… AQIï¼šåŸæœ¬è¦å‰‡ä¿ç•™ï¼ˆâ“˜æ—é‚Šç·Šé„° popoverï¼‰ */
    .info-btn:hover+.popover,
    .popover:hover {
      display: block;
    }

    /* âœ… THIï¼šæ”¹æˆ hover info-wrap é¡¯ç¤ºï¼ˆé¿å…èˆ‡ä¸Šé¢è¦å‰‡è¡çªï¼‰ */
    .info-wrap:hover .popover {
      display: block;
    }

    .aqi-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 12px;
    }

    .aqi-title {
      color: #fff;
      font-size: 16px;
    }

    .aqi-level {
      padding: 6px;
      border-radius: 4px;
      font-weight: bold;
      text-align: center;
      white-space: nowrap;
      width: 100%;
      box-sizing: border-box;
    }

    /* AQI è‰²éš */
    .level1 {
      background: rgba(121, 255, 121, 0.75);
      color: #000;
    }

    .level2 {
      background: rgba(255, 255, 111, 0.75);
      color: #000;
    }

    .level3 {
      background: rgba(255, 187, 119, 0.75);
      color: #000;
    }

    .level4 {
      background: rgba(255, 45, 45, 0.75);
      color: #fff;
    }

    .level5 {
      background: rgba(177, 91, 255, 0.75);
      color: #fff;
    }

    .level6 {
      background: rgba(126, 0, 35, 0.75);
      color: #fff;
    }

    /* THI è‰²éš */
    .thi1 {
      background: rgba(0, 80, 200, 0.75);
      color: #fff;
    }

    /* â‰¤10 */
    .thi2 {
      background: rgba(0, 150, 255, 0.75);
      color: #fff;
    }

    /* 11â€“15 */
    .thi3 {
      background: rgba(0, 220, 255, 0.75);
      color: #000;
    }

    /* 16â€“19 */
    .thi4 {
      background: rgba(0, 200, 80, 0.75);
      color: #000;
    }

    /* 20â€“26 */
    .thi5 {
      background: rgba(255, 120, 180, 0.75);
      color: #000;
    }

    /* 27â€“30 */
    .thi6 {
      background: rgba(255, 0, 0, 0.75);
      color: #fff;
    }

    /* â‰¥31 */
  </style>
</head>

<body>
  <div class="container">

    <!-- ç¬¬ä¸€æ’ï¼šæ™‚é–“ + æ¸¬ç«™é¸å–® -->
    <div class="row-top">
      <div id="datetime">--</div>
      <div>
        <label for="stationSelect">é¸æ“‡æ¸¬ç«™ï¼š</label>
        <select id="stationSelect">
          <option value="è‡ºå—">è‡ºå—ï¼ˆä¸­è¥¿å€ï¼‰</option>
          <option value="å®‰å—å€">å®‰å—</option>
          <option value="æ–°ç‡Ÿå€">æ–°ç‡Ÿ</option>
          <option value="å–„åŒ–å€">å–„åŒ–</option>
        </select>
      </div>
    </div>

    <!-- ç¬¬äºŒæ’ï¼šäº”å€‹è³‡è¨Š -->
    <div class="row-info">
      <div>ğŸŒ¡ æº«åº¦ï¼š<span id="temp">è¼‰å…¥ä¸­â€¦</span></div>
      <div>ğŸ’§ æ¿•åº¦ï¼š<span id="humidity">è¼‰å…¥ä¸­â€¦</span></div>

      <!-- THI -->
      <div style="position:relative; display:inline-block;">
        ğŸ˜Š THIï¼š<span id="thi">è¼‰å…¥ä¸­â€¦</span>

        <span class="info-wrap">
          <span class="info-btn">â“˜</span>
          <div class="popover popover-right">
            <b class="aqi-title">THI åˆ†ç´šèªªæ˜</b>
            <div class="aqi-grid">
              <div class="aqi-level thi1">â‰¤ 10 éå¸¸å¯’å†·</div>
              <div class="aqi-level thi2">11 â€“ 15 å¯’å†·</div>
              <div class="aqi-level thi3">16 â€“ 19 ç¨å¯’</div>
              <div class="aqi-level thi4">20 â€“ 26 èˆ’é©</div>
              <div class="aqi-level thi5">27 â€“ 30 æ‚¶ç†±</div>
              <div class="aqi-level thi6">â‰¥ 31 æ˜“ä¸­æš‘</div>
            </div>
          </div>
        </span>
      </div>

      <div>â›… å¤©æ°£ï¼š<span id="weather">è¼‰å…¥ä¸­â€¦</span></div>

      <!-- AQI -->
      <div style="position:relative; display:inline-block;">
        ğŸŒ« AQIï¼š<span id="aqi">è¼‰å…¥ä¸­â€¦</span>
        <span class="info-btn">â“˜</span>
        <div class="popover popover-fixed">
          <b class="aqi-title">AQI åˆ†ç´šèªªæ˜</b>
          <div class="aqi-grid">
            <div class="aqi-level level1">0-50 è‰¯å¥½</div>
            <div class="aqi-level level2">51-100 æ™®é€š</div>
            <div class="aqi-level level3">101-150 å°æ•æ„Ÿæ—ç¾¤ä¸å¥åº·</div>
            <div class="aqi-level level4">151-200 å°æ‰€æœ‰äººä¸å¥åº·</div>
            <div class="aqi-level level5">201-300 éå¸¸ä¸å¥åº·</div>
            <div class="aqi-level level6">301+ å±å®³</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // æ™‚é–“
    function updateTime() {
      const now = new Date();
      const weekdays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
      const formatted = now.toLocaleDateString() + " (é€±" + weekdays[now.getDay()] + ") " + now.toLocaleTimeString();
      document.getElementById("datetime").innerText = formatted;
    }
    setInterval(updateTime, 1000);
    updateTime();

    // AQI é¡è‰²
    function getAQIColor(aqi) {
      if (aqi <= 50) return "#79FF79";
      if (aqi <= 100) return "#FFFF6F";
      if (aqi <= 150) return "#FFBB77";
      if (aqi <= 200) return "#FF2D2D";
      if (aqi <= 300) return "#B15BFF";
      return "#7E0023";
    }

    // THI åˆ†ç´š
    function getTHILevel(thi) {
      if (thi <= 10) return { label: "éå¸¸å¯’å†·", cls: "thi1" };
      if (thi <= 15) return { label: "å¯’å†·", cls: "thi2" };
      if (thi <= 19) return { label: "ç¨å¯’", cls: "thi3" };
      if (thi <= 26) return { label: "èˆ’é©", cls: "thi4" };
      if (thi <= 30) return { label: "æ‚¶ç†±", cls: "thi5" };
      return { label: "æ˜“ä¸­æš‘", cls: "thi6" };
    }

    // âœ… ä¿®æ­£ï¼šRH è¦ç”¨ 0~1ï¼ˆRH/100ï¼‰ï¼Œä¸ç„¶ Td/THI æœƒçˆ†è¡¨
    // Td = (RH/100)^(1/8) (112 + 0.9T) + 0.1T âˆ’ 112
    function calcTd(T, RH_percent) {
      const RH = RH_percent / 100;
      return Math.pow(RH, 1 / 8) * (112 + 0.9 * T) + 0.1 * T - 112;
    }

    // THI = T âˆ’ 0.55[1 âˆ’ exp(17.269Td/(Td+237.3))/exp(17.269T/(T+237.3))](Tâˆ’14)
    function calcTHI(T, Td) {
      const a = Math.exp((17.269 * Td) / (Td + 237.3));
      const b = Math.exp((17.269 * T) / (T + 237.3));
      return T - 0.55 * (1 - a / b) * (T - 14);
    }

    let latestTemp = null;
    let latestHum = null;

    function updateTHIBox() {
      const thiBox = document.getElementById("thi");
      if (!thiBox) return;

      if (!Number.isFinite(latestTemp) || !Number.isFinite(latestHum) || latestHum <= 0) {
        thiBox.innerText = "è¼‰å…¥ä¸­â€¦";
        thiBox.className = "";
        thiBox.style.backgroundColor = "transparent";
        return;
      }

      const Td = calcTd(latestTemp, latestHum);
      const thi = calcTHI(latestTemp, Td);

      const thiRounded = Math.round(thi * 10) / 10;
      const lv = getTHILevel(thiRounded);

      thiBox.innerText = `${thiRounded} (${lv.label})`;

      // æ¸…æ‰ inline èƒŒæ™¯ï¼Œé¿å…è“‹æ‰ class èƒŒæ™¯
      thiBox.style.backgroundColor = "";

      thiBox.className = "";
      thiBox.classList.add(lv.cls);
    }

    // âœ…âœ…âœ… æ”¹ï¼šæ¸¬ç«™ mappingï¼ˆæº«æ¿•åº¦æ”¹ç”¨ CWA stationIdï¼‰
    const stationMap = {
      "è‡ºå—": { aqi: "è‡ºå—", cwaId: "467410", weatherId: "467420" }, // â† åŸæœ¬ 467410 æ”¹æˆ C0O900
      "å®‰å—å€": { aqi: "å®‰å—", cwaId: "C2O950", weatherId: "CAN040" },
      "æ–°ç‡Ÿå€": { aqi: "æ–°ç‡Ÿ", cwaId: "C0X250", weatherId: "CAN010" },
      "å–„åŒ–å€": { aqi: "å–„åŒ–", cwaId: "C0O900", weatherId: "CAN090" }
    };

    // âœ…âœ…âœ… æ”¹ï¼šç”¨ CWA O-A0001-001 æŠ“æº«æ¿•åº¦ï¼ˆä¸€æ¬¡æŠ“å®Œï¼‰
    const CWA_API =
      "https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0001-001?Authorization=CWA-3658EFC9-2F77-426A-BEC8-EE60503417C9&format=JSON";

    let cwaCache = { ts: 0, byId: new Map() };
    const CWA_CACHE_MS = 60 * 1000; // 1åˆ†é˜æ›´æ–°ä¸€æ¬¡

    async function fetchCWAAllStations() {
      const now = Date.now();
      if (cwaCache.byId.size > 0 && now - cwaCache.ts < CWA_CACHE_MS) {
        return cwaCache.byId;
      }

      const res = await fetch(CWA_API, { cache: "no-store" });
      const json = await res.json();

      // å…¼å®¹ä¸åŒå±¤ç´šçµæ§‹
      const locations =
        json?.records?.location ||
        json?.records?.locations?.[0]?.location ||
        [];

      const map = new Map();
      for (const loc of locations) {
        const id = loc?.stationId || loc?.StationId || loc?.locationId || loc?.LocationId;
        if (!id) continue;
        map.set(String(id).trim(), loc);
      }

      cwaCache = { ts: now, byId: map };
      return map;
    }

    function getElementValue(weatherElementArray, elementName) {
      const el = (weatherElementArray || []).find(e =>
        (e.elementName || e.ElementName || "").toUpperCase() === elementName.toUpperCase()
      );
      const v = el?.elementValue ?? el?.ElementValue;
      const n = parseFloat(v);
      return Number.isFinite(n) ? n : null;
    }

    // âœ… å¾ CWA payload æ‰¾åˆ°æŒ‡å®š StationId çš„é‚£ç­† location
    function findCwaLocationById(payload, stationId) {
      // âœ… ä½ çš„ JSON æ˜¯ records.Stationï¼ˆé™£åˆ—ï¼‰
      const list =
        payload?.records?.Station ||
        payload?.records?.station ||
        payload?.records?.location ||
        payload?.records?.Location ||
        [];

      if (!Array.isArray(list)) return null;

      const sid = String(stationId).trim();
      return list.find(x => String(x.StationId).trim() === sid) || null;
    }


    // âœ… æº«åº¦ï¼ˆCWAï¼‰
    async function loadTemp(station) {
      const stationId = stationMap[station].cwaId; // â† ä½  stationMap è£¡é‚£å€‹ CWA ç«™è™Ÿæ¬„ä½
      try {
        const res = await fetch(CWA_API, { cache: "no-store" });
        const payload = await res.json();

        const loc = findCwaLocationById(payload, stationId);
        if (!loc) throw new Error(`CWA æ‰¾ä¸åˆ° stationId=${stationId}`);

        const t = parseFloat(loc.WeatherElement?.AirTemperature);
        if (!Number.isFinite(t) || t === -99) throw new Error(`CWA æº«åº¦ç„¡æ•ˆï¼š${loc.WeatherElement?.AirTemperature}`);

        document.getElementById("temp").innerText = `${t.toFixed(1)} Â°C`;
        latestTemp = t;

      } catch (e) {
        console.error("[CWA][TEMP] load failed:", e);
        document.getElementById("temp").innerText = "âš  è®€å–å¤±æ•—";
        latestTemp = null;
      } finally {
        updateTHIBox();
      }
    }

    // âœ… æ¿•åº¦ï¼ˆCWAï¼‰
    async function loadHumidity(station) {
      const stationId = stationMap[station].cwaId;
      try {
        const res = await fetch(CWA_API, { cache: "no-store" });
        const payload = await res.json();

        const loc = findCwaLocationById(payload, stationId);
        if (!loc) throw new Error(`CWA æ‰¾ä¸åˆ° stationId=${stationId}`);

        const h = parseFloat(loc.WeatherElement?.RelativeHumidity);
        if (!Number.isFinite(h) || h === -99) throw new Error(`CWA æ¿•åº¦ç„¡æ•ˆï¼š${loc.WeatherElement?.RelativeHumidity}`);

        // âœ… ä½ çš„ HTML ç”¨çš„æ˜¯ id="humidity"
        document.getElementById("humidity").innerText = `${h.toFixed(0)} %`;
        latestHum = h;

      } catch (e) {
        console.error("[CWA][HUM] load failed:", e);
        document.getElementById("humidity").innerText = "âš  è®€å–å¤±æ•—";
        latestHum = null;
      } finally {
        updateTHIBox();
      }
    }

    async function loadWeather(station) {
      const id = stationMap[station].weatherId;
      try {
        const url = `https://sta.ci.taiwan.gov.tw/STA_Weather/v1.0/Datastreams?$expand=Thing,Observations($orderby=phenomenonTime desc;$top=1)&$filter=Thing/properties/stationID eq '${id}'`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.value.length > 0 && data.value[0].Observations.length > 0) {
          document.getElementById("weather").innerText = data.value[0].Observations[0].result;
        } else {
          document.getElementById("weather").innerText = "âš  ç„¡è³‡æ–™";
        }
      } catch {
        document.getElementById("weather").innerText = "âš  è®€å–å¤±æ•—";
      }
    }

    async function loadAQI(station) {
      const aqiBox = document.getElementById("aqi");
      aqiBox.innerText = "è¼‰å…¥ä¸­â€¦";
      aqiBox.style.backgroundColor = "transparent";
      try {
        const res = await fetch("https://data.moenv.gov.tw/api/v2/aqx_p_432?api_key=9e565f9a-84dd-4e79-9097-d403cae1ea75&limit=1000&sort=ImportDate desc&format=JSON");
        const data = await res.json();
        const record = data.records.find(r => r.sitename === stationMap[station].aqi);
        if (record) {
          const aqi = parseInt(record.aqi);
          aqiBox.innerText = `${aqi} (${record.status})`;
          aqiBox.style.backgroundColor = getAQIColor(aqi);
        } else {
          aqiBox.innerText = "âš  æ‰¾ä¸åˆ°æ¸¬ç«™";
        }
      } catch {
        aqiBox.innerText = "âš  è®€å–å¤±æ•—";
      }
    }

    function updateAll(station) {
      latestTemp = null;
      latestHum = null;
      updateTHIBox();
      loadTemp(station);
      loadHumidity(station);
      loadWeather(station);
      loadAQI(station);
    }

    const defaultStation = "è‡ºå—";
    updateAll(defaultStation);

    document.getElementById("stationSelect").addEventListener("change", function () {
      updateAll(this.value);
    });

    setInterval(() => {
      const currentStation = document.getElementById("stationSelect").value;
      updateAll(currentStation);
      console.log("â³ è‡ªå‹•åˆ·æ–°å®Œæˆï¼Œæ¸¬ç«™ï¼š" + currentStation);
    }, 300000);

  </script>
</body>

</html>
