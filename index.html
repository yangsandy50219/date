<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <title>å°å—å¸‚å³æ™‚ç’°å¢ƒè³‡è¨Š</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background: #fff;
      margin: 20px;
      font-size: 20px;
    }

    .row-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .row-info {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    /* åªå¥—ç”¨åœ¨ .row-info çš„ç›´å±¬å››å€‹æ¬„ä½ */
    .row-info>div:nth-child(1) {
      text-align: left;
    }

    .row-info>div:nth-child(2) {
      text-align: center;
    }

    .row-info>div:nth-child(3) {
      text-align: center;
    }

    .row-info>div:nth-child(4) {
      text-align: right;
    }


    #aqi {
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 4px;
    }

    /* â“˜ æŒ‰éˆ• */
    .info-btn {
      display: inline-block;
      margin-left: 8px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 1px solid #333;
      text-align: center;
      font-size: 14px;
      line-height: 20px;
      cursor: default;
    }

    /* è³‡è¨Šæç¤ºæ¡† */
    .popover {
      display: none;
      position: fixed;
      /* ğŸ”‘ ç”¨ fixed å®šä½åœ¨è¦–çª— */
      top: 5px;
      /* ç•«é¢æœ€ä¸Šæ–¹ */
      right: 20px;

      /* èª¿æ•´æˆçœŸæ­£ç½®ä¸­ */
      background: rgba(145, 137, 137, 0.8);
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      width: 400px;
      font-size: 14px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      z-index: 9999;
    }


    .info-btn:hover+.popover,
    .popover:hover {
      display: block;
    }

    .aqi-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      /* å…©æ¬„ */
      gap: 6px 12px;
      /* ä¸Šä¸‹é–“è·6px, å·¦å³é–“è·12px */
    }

    .aqi-title {
      color: #ffffff;
      /* ä½ æƒ³è¦çš„é¡è‰²ï¼Œä¾‹å¦‚æ·±ç° */
      font-size: 16px;
      /* å¦‚æœæƒ³åŠ å¤§ */
    }

    .aqi-level {
      padding: 6px;
      border-radius: 4px;
      font-weight: bold;
      text-align: center;
      /* æ–‡å­—æ°´å¹³ç½®ä¸­ */
      white-space: nowrap;
      width: 100%;
      /* ä¿è­‰æ¯æ ¼ä¸€æ¨£å¯¬ */
      box-sizing: border-box;
    }


    .level1 {
      background: rgba(121, 255, 121, 0.75);
      /* #79FF79 */
      color: #000;
    }

    .level2 {
      background: rgba(255, 255, 111, 0.75);
      /* #FFFF6F */
      color: #000;
    }

    .level3 {
      background: rgba(255, 187, 119, 0.75);
      /* #FFBB77 */
      color: #000;
    }

    .level4 {
      background: rgba(255, 45, 45, 0.75);
      /* #FF2D2D */
      color: #fff;
    }

    .level5 {
      background: rgba(177, 91, 255, 0.75);
      /* #B15BFF */
      color: #fff;
    }

    .level6 {
      background: rgba(126, 0, 35, 0.75);
      /* #7E0023 */
      color: #fff;
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- ç¬¬ä¸€æ’ï¼šæ™‚é–“ + æ¸¬ç«™é¸å–® -->
    <div class="row-top">
      <div id="datetime">--</div>
      <div>
        <label for="stationSelect">é¸æ“‡æ¸¬ç«™ï¼š</label>
        <select id="stationSelect">
          <option value="è‡ºå—">è‡ºå—ï¼ˆæ±å€ï¼‰</option>
          <option value="å®‰å—">å®‰å—</option>
          <option value="æ–°ç‡Ÿ">æ–°ç‡Ÿ</option>
          <option value="å–„åŒ–">å–„åŒ–</option>
        </select>
      </div>
    </div>

    <!-- ç¬¬äºŒæ’ï¼šå››å€‹è³‡è¨Š -->
    <div class="row-info">
      <div>ğŸŒ¡ æº«åº¦ï¼š<span id="temp">è¼‰å…¥ä¸­â€¦</span></div>
      <div>ğŸ’§ æ¿•åº¦ï¼š<span id="humidity">è¼‰å…¥ä¸­â€¦</span></div>
      <div>â›… å¤©æ°£ï¼š<span id="weather">è¼‰å…¥ä¸­â€¦</span></div>
      <!-- æç¤ºè¦–çª— -->
      <div style="position:relative; display:inline-block;">
        ğŸŒ« AQIï¼š<span id="aqi">è¼‰å…¥ä¸­â€¦</span>
        <span class="info-btn">i</span>
        <div class="popover">
          <b class="aqi-title">AQI åˆ†ç´šèªªæ˜</b>
          <div class="aqi-grid">
            <div class="aqi-level level1">0-50 è‰¯å¥½</div>
            <div class="aqi-level level2">51-100 æ™®é€š</div>
            <div class="aqi-level level3">101-150 å°æ•æ„Ÿæ—ç¾¤ä¸å¥åº·</div>
            <div class="aqi-level level4">151-200 å°æ‰€æœ‰äººä¸å¥åº·</div>
            <div class="aqi-level level5">201-300 éå¸¸ä¸å¥åº·</div>
            <div class="aqi-level level6">301+ å±å®³</div>
          </div>
        </div>



      </div>
    </div>



    <script>
      // æ™‚é–“
      function updateTime() {
        const now = new Date();
        const weekdays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
        const formatted = now.toLocaleDateString() + " (é€±" + weekdays[now.getDay()] + ") " +
          now.toLocaleTimeString();
        document.getElementById("datetime").innerText = formatted;
      }
      setInterval(updateTime, 1000);
      updateTime();

      // AQI é¡è‰²
      function getAQIColor(aqi) {
        if (aqi <= 50) return "#79FF79";       // ç¶ 
        if (aqi <= 100) return "#FFFF6F";      // é»ƒ
        if (aqi <= 150) return "#FFBB77";      // æ©˜
        if (aqi <= 200) return "#FF2D2D";      // ç´…
        if (aqi <= 300) return "#B15BFF";      // ç´«
        return "#7E0023";                      // è¤ç´…
      }

      // æº«åº¦ + æ¿•åº¦
      async function loadTempHumidity() {
        try {
          const tempRes = await fetch("https://sta.ci.taiwan.gov.tw/STA_AirQuality_EPAIoT/v1.0/Datastreams?$expand=Thing,Observations($orderby=phenomenonTime%20desc;$top=1)&$filter=name%20eq%20%27Temperature%27&$count=true");
          const tempData = await tempRes.json();
          document.getElementById("temp").innerText = tempData.value[0].Observations[0].result + " Â°C";

          const humRes = await fetch("https://sta.ci.taiwan.gov.tw/STA_AirQuality_EPAIoT/v1.0/Datastreams?$expand=Thing,Observations($orderby=phenomenonTime%20desc;$top=1)&$filter=name%20eq%20%27Relative%20humidity%27&$count=true");
          const humData = await humRes.json();
          document.getElementById("humidity").innerText = humData.value[0].Observations[0].result + " %";
        } catch (err) {
          document.getElementById("temp").innerText = "âš  è®€å–å¤±æ•—";
          document.getElementById("humidity").innerText = "âš  è®€å–å¤±æ•—";
        }
      }

      // å¤©æ°£
      async function loadWeather() {
        try {
          const res = await fetch("https://sta.ci.taiwan.gov.tw/STA_Weather/v1.0/Datastreams?$expand=Thing/Locations,Observations($orderby=phenomenonTime%20desc;$top=1)&$select=name,properties&$filter=substringof(%27%E7%8F%BE%E5%9C%A8%E5%A4%A9%E6%B0%A3%E8%A7%80%E6%B8%AC%E5%A0%B1%E5%91%8A%27,Thing/description)&$count=true");
          const data = await res.json();
          document.getElementById("weather").innerText = data.value[0].Observations[0].result;
        } catch (err) {
          document.getElementById("weather").innerText = "âš  è®€å–å¤±æ•—";
        }
      }

      // AQI
      async function loadAQI(stationName = "è‡ºå—") {
        const aqiBox = document.getElementById("aqi");
        aqiBox.innerText = "è¼‰å…¥ä¸­â€¦";
        aqiBox.style.backgroundColor = "transparent";

        try {
          const res = await fetch("https://data.moenv.gov.tw/api/v2/aqx_p_432?api_key=9e565f9a-84dd-4e79-9097-d403cae1ea75&limit=1000&sort=ImportDate%20desc&format=JSON");
          const data = await res.json();
          const station = data.records.find(r => r.sitename === stationName);

          if (station) {
            const aqi = parseInt(station.aqi);
            aqiBox.innerText = `${aqi} (${station.status})`;
            aqiBox.style.backgroundColor = getAQIColor(aqi);
          } else {
            aqiBox.innerText = "âš  æ‰¾ä¸åˆ°æ¸¬ç«™";
            aqiBox.style.backgroundColor = "transparent";
          }
        } catch (err) {
          aqiBox.innerText = "âš  è®€å–å¤±æ•—";
          aqiBox.style.backgroundColor = "transparent";
        }
      }

      // åˆå§‹åŒ–
      loadTempHumidity();
      loadWeather();
      loadAQI();

      // åˆ‡æ›æ¸¬ç«™
      document.getElementById("stationSelect").addEventListener("change", function () {
        loadAQI(this.value);
      });


    </script>
</body>

</html>
